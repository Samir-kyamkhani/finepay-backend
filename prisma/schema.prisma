generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
}

// ==================== CORE USER SYSTEM ====================

model User {
  id                       String     @id @default(uuid())
  customerId               String     @unique @map("customer_id") @db.VarChar(8)
  firstName                String     @map("first_name")
  lastName                 String     @map("last_name")
  profileImage             String?    @map("profile_image") @db.Text
  email                    String     @unique
  phoneNumber              String     @unique @map("phone_number")
  password                 String
  transactionPin           String?    @map("transaction_pin")
  hierarchyLevel           Int        @default(0) @map("hierarchy_level")
  hierarchyPath            String     @map("hierarchy_path")
  status                   UserStatus @default(INACTIVE)
  isKycVerified            Boolean    @default(false) @map("is_kyc_verified")
  roleId                   String     @map("role_id")
  refreshToken             String?    @map("refresh_token") @db.Text
  passwordResetToken       String?    @map("password_reset_token") @db.Text
  passwordResetExpires     DateTime?  @map("password_reset_expires")
  emailVerificationToken   String?    @map("email_verification_token")
  emailVerifiedAt          DateTime?  @map("email_verified_at")
  emailVerificationExpires DateTime?  @map("email_verification_token_expires")
  lastLoginAt              DateTime?  @map("last_login_at")
  lastLoginIp              String?    @map("last_login_ip") @db.Inet
  lastLoginOrigin          String?    @map("last_login_origin")
  actionReason             String?    @map("action_reason") @db.Text
  actionedAt               DateTime   @map("actioned_at")
  createdAt                DateTime   @default(now()) @map("created_at")
  updatedAt                DateTime   @updatedAt @map("updated_at")
  deletedAt                DateTime?  @map("deleted_at")

  // Relations
  parentId      String? @map("parent_id")
  businessKycId String? @map("business_kyc_id")

  role     Role   @relation(fields: [roleId], references: [id])
  parent   User?  @relation("UserHierarchy", fields: [parentId], references: [id])
  children User[] @relation("UserHierarchy")

  wallets      Wallet[]
  bankDetails  BankDetail[]
  userKyc      UserKyc?
  businessKyc  BusinessKyc?
  transactions Transaction[]

  commissionEarnings CommissionEarning[] @relation("CommissionEarningToUser")
  commissionsGiven   CommissionEarning[] @relation("CommissionEarningFromUser")

  piiConsents  PiiConsent[]
  apiEntities  ApiEntity[]
  ipWhitelists IpWhitelist[]
  employees    Employee[]

  commissionSettings        CommissionSetting[] @relation("CommissionSettingForUser")
  commissionSettingsCreated CommissionSetting[] @relation("CommissionSettingCreatedByUser")
  rolesCreated              Role[]              @relation("RoleCreatedByUser")
  departmentsCreated        Department[]        @relation("DepartmentCreatedByUser")
  serviceProviders          ServiceProvider[]
  serviceProvidersAssigned  ServiceProvider[]   @relation("ServiceProviderAssignedByUser")
  systemSettings            SystemSetting[]

  permissionsAssigned   Permission[] @relation("PermissionAssignedToUser")
  permissionsAssignedBy Permission[] @relation("PermissionAssignedByUser")

  userKycVerified     UserKyc[]        @relation("UserKycVerifiedByUser")
  businessKycVerified BusinessKyc[]    @relation("BusinessKycVerifiedByUser")
  apiIntegrations     ApiIntegration[]

  @@index([parentId])
  @@index([hierarchyLevel])
  @@index([hierarchyPath])
  @@index([roleId])
  @@index([customerId])
  @@index([businessKycId])
  @@index([email])
  @@index([phoneNumber])
  @@index([deletedAt])
  @@map("users")
}

model Employee {
  id                   String         @id @default(uuid())
  username             String         @unique
  firstName            String         @map("first_name")
  lastName             String         @map("last_name")
  profileImage         String?        @map("profile_image") @db.Text
  email                String         @unique
  phoneNumber          String         @unique @map("phone_number")
  password             String
  departmentId         String         @map("department_id")
  status               EmployeeStatus @default(ACTIVE)
  refreshToken         String?        @map("refresh_token") @db.Text
  passwordResetToken   String?        @map("password_reset_token") @db.Text
  passwordResetExpires DateTime?      @map("password_reset_expires")
  lastLoginAt          DateTime?      @map("last_login_at")
  lastLoginIp          String?        @map("last_login_ip") @db.Inet
  lastLoginOrigin      String?        @map("last_login_origin")
  actionReason         String?        @map("action_reason") @db.Text
  actionedAt           DateTime       @map("actioned_at")
  createdById          String         @map("created_by_user_id")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  department          Department          @relation(fields: [departmentId], references: [id])
  createdBy           User                @relation(fields: [createdById], references: [id])
  permissions         Permission[]        @relation("PermissionAssignedToEmployee")
  permissionsAssigned Permission[]        @relation("PermissionAssignedByEmployee")
  commissionSettings  CommissionSetting[] @relation("CommissionSettingCreatedByEmployee")
  businessKycVerified BusinessKyc[]       @relation("BusinessKycVerifiedByEmployee")

  @@index([departmentId])
  @@index([createdById])
  @@index([email])
  @@index([phoneNumber])
  @@map("employees")
}

// ==================== PERMISSION SYSTEM ====================

model Permission {
  id                   String               @id @default(uuid())
  resource             String               @db.VarChar(200)
  action               String               @db.VarChar(200)
  description          String?              @db.Text
  targetType           PermissionTargetType @map("target_type")
  roleId               String?              @map("role_id")
  userId               String?              @map("user_id")
  departmentId         String?              @map("department_id")
  employeeId           String?              @map("employee_id")
  isActive             Boolean              @default(true) @map("is_active")
  assignedAt           DateTime             @default(now()) @map("assigned_at")
  revokedAt            DateTime?            @map("revoked_at")
  assignedByType       CreatorType          @map("assigned_by_type")
  assignedByUserId     String?              @map("assigned_by_user_id")
  assignedByEmployeeId String?              @map("assigned_by_employee_id")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")

  role               Role?       @relation(fields: [roleId], references: [id])
  user               User?       @relation("PermissionAssignedToUser", fields: [userId], references: [id])
  department         Department? @relation(fields: [departmentId], references: [id])
  employee           Employee?   @relation("PermissionAssignedToEmployee", fields: [employeeId], references: [id])
  assignedByUser     User?       @relation("PermissionAssignedByUser", fields: [assignedByUserId], references: [id])
  assignedByEmployee Employee?   @relation("PermissionAssignedByEmployee", fields: [assignedByEmployeeId], references: [id])

  @@unique([resource, action, targetType, roleId, userId, departmentId, employeeId])
  @@index([resource, action])
  @@index([targetType])
  @@index([roleId])
  @@index([userId])
  @@index([departmentId])
  @@index([employeeId])
  @@index([isActive])
  @@index([assignedByUserId])
  @@map("permissions")
}

// ==================== WALLET & TRANSACTION SYSTEM ====================

model Wallet {
  id                  String     @id @default(uuid())
  userId              String     @map("user_id")
  balance             Decimal    @default(0) @db.Decimal(20, 2) // Using Decimal for monetary values
  currency            Currency   @default(INR)
  walletType          WalletType @default(PRIMARY) @map("wallet_type")
  holdBalance         Decimal    @default(0) @map("hold_balance") @db.Decimal(20, 2)
  availableBalance    Decimal    @default(0) @map("available_balance") @db.Decimal(20, 2)
  dailyLimit          Decimal?   @map("daily_limit") @db.Decimal(20, 2)
  monthlyLimit        Decimal?   @map("monthly_limit") @db.Decimal(20, 2)
  perTransactionLimit Decimal?   @map("per_transaction_limit") @db.Decimal(20, 2)
  isActive            Boolean    @default(true) @map("is_active")
  version             Int        @default(1)
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  deletedAt           DateTime?  @map("deleted_at")

  user          User          @relation(fields: [userId], references: [id])
  ledgerEntries LedgerEntry[]
  transactions  Transaction[]

  @@unique([userId, walletType])
  @@index([userId])
  @@index([walletType])
  @@index([isActive])
  @@index([createdAt])
  @@index([balance])
  @@index([deletedAt])
  @@map("wallets")
}

model Transaction {
  id                String            @id @default(uuid())
  referenceId       String?           @unique @map("reference_id") @db.VarChar(50)
  externalRefId     String?           @map("external_ref_id") @db.VarChar(100)
  idempotencyKey    String?           @unique @map("idempotency_key") @db.VarChar(255)
  amount            Decimal           @db.Decimal(20, 2)
  currency          Currency          @default(INR)
  netAmount         Decimal           @map("net_amount") @db.Decimal(20, 2)
  status            TransactionStatus @default(PENDING)
  serviceId         String?           @map("service_id")
  paymentType       PaymentType       @map("payment_type")
  userId            String            @map("user_id")
  walletId          String            @map("wallet_id")
  apiEntityId       String?           @map("api_entity_id")
  totalCommission   Decimal           @default(0) @map("total_commission") @db.Decimal(20, 2)
  providerCharge    Decimal?          @map("provider_charge") @db.Decimal(20, 2)
  taxAmount         Decimal?          @map("tax_amount") @db.Decimal(20, 2)
  feeAmount         Decimal?          @map("fee_amount") @db.Decimal(20, 2)
  cashbackAmount    Decimal?          @map("cashback_amount") @db.Decimal(20, 2)
  providerReference String?           @map("provider_reference") @db.VarChar(100)
  providerResponse  Json?             @map("provider_response") @db.Json
  requestPayload    Json?             @map("request_payload") @db.Json
  responsePayload   Json?             @map("response_payload") @db.Json
  initiatedAt       DateTime          @default(now()) @map("initiated_at")
  processedAt       DateTime?         @map("processed_at")
  completedAt       DateTime?         @map("completed_at")

  user               User                @relation(fields: [userId], references: [id])
  wallet             Wallet              @relation(fields: [walletId], references: [id])
  apiEntity          ApiEntity?          @relation(fields: [apiEntityId], references: [id])
  service            ServiceProvider?    @relation(fields: [serviceId], references: [id])
  apiWebhooks        ApiWebhook[]
  commissionEarnings CommissionEarning[]
  ledgerEntries      LedgerEntry[]
  refunds            Refund[]

  @@index([userId])
  @@index([walletId])
  @@index([serviceId])
  @@index([apiEntityId])
  @@index([initiatedAt])
  @@index([status, initiatedAt])
  @@index([paymentType])
  @@index([processedAt])
  @@index([completedAt])
  @@index([externalRefId])
  @@index([providerReference])
  // PostgreSQL-specific composite indexes for common queries
  @@index([userId, status, initiatedAt])
  @@index([walletId, status, initiatedAt])
  @@map("transactions")
}

model CommissionEarning {
  id               String           @id @default(uuid())
  transactionId    String           @map("transaction_id")
  userId           String           @map("user_id")
  fromUserId       String?          @map("from_user_id")
  amount           Decimal          @db.Decimal(20, 2)
  commissionAmount Decimal          @map("commission_amount") @db.Decimal(20, 2)
  commissionType   CommissionType   @map("commission_type")
  tdsAmount        Decimal?         @map("tds_amount") @db.Decimal(20, 2)
  gstAmount        Decimal?         @map("gst_amount") @db.Decimal(20, 2)
  netAmount        Decimal          @map("net_amount") @db.Decimal(20, 2)
  status           CommissionStatus @default(PENDING)
  metadata         Json?            @db.Json
  processedAt      DateTime?        @map("processed_at")
  cancelledAt      DateTime?        @map("cancelled_at")
  failureReason    String?          @map("failure_reason") @db.Text
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])
  user        User        @relation("CommissionEarningToUser", fields: [userId], references: [id])
  fromUser    User?       @relation("CommissionEarningFromUser", fields: [fromUserId], references: [id])

  @@index([transactionId, userId])
  @@index([userId, createdAt])
  @@index([fromUserId, createdAt])
  @@index([status, createdAt])
  @@index([processedAt])
  @@index([cancelledAt])
  // Composite index for common reporting queries
  @@index([userId, status, createdAt])
  @@map("commission_earnings")
}

model BankDetail {
  id                  String           @id @default(uuid())
  accountHolder       String           @map("account_holder") @db.VarChar(100)
  accountNumber       String           @unique @map("account_number") @db.VarChar(18)
  phoneNumber         String           @map("phone_number") @db.VarChar(15)
  accountType         BankAccountType  @map("account_type")
  ifscCode            String           @map("ifsc_code") @db.VarChar(11)
  bankName            String           @map("bank_name") @db.VarChar(100)
  bankRejectionReason String?          @map("bank_rejection_reason") @db.Text
  bankProofFile       String           @map("bank_proof_file") @db.VarChar(500)
  status              BankDetailStatus @default(PENDING)
  isPrimary           Boolean          @default(false) @map("is_primary")
  userId              String           @map("user_id")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, isPrimary]) // Partial unique index
  @@index([userId])
  @@index([status])
  @@index([isPrimary])
  @@index([createdAt])
  @@index([ifscCode])
  @@map("bank_details")
}

model LedgerEntry {
  id             String          @id @default(uuid())
  transactionId  String?         @map("transaction_id")
  walletId       String          @map("wallet_id")
  entryType      LedgerEntryType @map("entry_type")
  referenceType  ReferenceType   @map("reference_type")
  serviceId      String?         @map("service_id")
  amount         Decimal         @db.Decimal(20, 2)
  runningBalance Decimal         @map("running_balance") @db.Decimal(20, 2)
  narration      String          @db.VarChar(500)
  metadata       Json?           @db.Json
  idempotencyKey String          @unique @map("idempotency_key") @db.VarChar(255)
  createdAt      DateTime        @default(now()) @map("created_at")

  service     ServiceProvider? @relation(fields: [serviceId], references: [id])
  transaction Transaction?     @relation(fields: [transactionId], references: [id])
  wallet      Wallet           @relation(fields: [walletId], references: [id])

  @@index([transactionId])
  @@index([walletId, createdAt])
  @@index([serviceId, referenceType])
  @@index([entryType, createdAt])
  @@index([referenceType, createdAt])
  @@index([createdAt])
  @@index([walletId, entryType, createdAt])
  @@index([walletId, runningBalance])
  @@map("ledger_entries")
}

// ==================== COMMISSION & SETTINGS ====================

model CommissionSetting {
  id String @id @default(uuid())

  scope        CommissionScope @map("scope")
  roleId       String?         @map("role_id")
  targetUserId String?         @map("target_user_id")
  serviceId    String?         @map("service_id")

  commissionType  CommissionType? @map("commission_type")
  commissionValue Decimal?        @map("commission_value") @db.Decimal(12, 4)

  surchargeType  CommissionType? @map("surcharge_type")
  surchargeValue Decimal?        @map("surcharge_value") @db.Decimal(12, 4)

  minAmount Decimal? @map("min_amount") @db.Decimal(20, 2)
  maxAmount Decimal? @map("max_amount") @db.Decimal(20, 2)

  applyTDS   Boolean  @default(false) @map("apply_tds")
  tdsPercent Decimal? @map("tds_percent") @db.Decimal(5, 2)
  applyGST   Boolean  @default(false) @map("apply_gst")
  gstPercent Decimal? @map("gst_percent") @db.Decimal(5, 2)

  isActive      Boolean   @default(true) @map("is_active")
  effectiveFrom DateTime  @default(now()) @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  createdByType       CreatorType @map("created_by_type")
  createdByUserId     String?     @map("created_by_user_id")
  createdByEmployeeId String?     @map("created_by_employee_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  role              Role?            @relation(fields: [roleId], references: [id])
  targetUser        User?            @relation("CommissionSettingForUser", fields: [targetUserId], references: [id])
  service           ServiceProvider? @relation(fields: [serviceId], references: [id])
  createdByUser     User?            @relation("CommissionSettingCreatedByUser", fields: [createdByUserId], references: [id])
  createdByEmployee Employee?        @relation("CommissionSettingCreatedByEmployee", fields: [createdByEmployeeId], references: [id])

  @@index([scope, roleId, targetUserId])
  @@index([serviceId, isActive])
  @@index([createdByType, createdByUserId, createdByEmployeeId])
  @@index([effectiveFrom, effectiveTo])
  // Partial index for active settings
  @@index([scope, roleId, targetUserId, serviceId])
  @@map("commission_settings")
}

model Role {
  id          String  @id @default(uuid())
  name        String  @unique @db.VarChar(50)
  description String? @db.Text

  // Hierarchy fields
  parentId       String? @map("parent_id")
  hierarchyLevel Int     @default(0) @map("hierarchy_level")
  hierarchyPath  String  @map("hierarchy_path") @db.Text

  // Status and metadata
  isRoot        Boolean @default(false) @map("is_root")
  permissions   Json?   @db.Json // Cache of computed permissions
  isIpWhitelist Boolean @default(false) @map("is_ipwhitelist")

  createdByType   CreatorType @map("created_by_type")
  createdByUserId String?     @map("created_by_user_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  parent   Role?  @relation("RoleHierarchy", fields: [parentId], references: [id])
  children Role[] @relation("RoleHierarchy")

  users              User[]
  commissionSettings CommissionSetting[]
  createdByUser      User?               @relation("RoleCreatedByUser", fields: [createdByUserId], references: [id])
  rolePermissions    Permission[]

  @@index([parentId])
  @@index([hierarchyLevel])
  @@index([hierarchyPath])
  @@index([isRoot])
  @@index([createdByUserId, createdByType])
  @@index([name])
  @@index([hierarchyLevel, hierarchyPath])
  @@map("roles")
}

model Department {
  id              String      @id @default(uuid())
  name            String      @unique @db.VarChar(50)
  description     String?     @db.Text
  createdByType   CreatorType @map("created_by_type")
  createdByUserId String      @map("created_by_user_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  employees     Employee[]
  createdByUser User?        @relation("DepartmentCreatedByUser", fields: [createdByUserId], references: [id])
  permissions   Permission[]

  @@index([createdByUserId, createdByType])
  @@index([name])
  @@map("departments")
}

// ==================== SERVICE & INTEGRATION SYSTEM ====================

model ServiceProvider {
  id               String         @id @default(uuid())
  integrationId    String         @map("integration_id")
  serviceName      String         @map("service_name") @db.VarChar(100)
  status           ServiceStatus  @default(ACTIVE)
  assignedByType   AssignedByType @map("assigned_by_type")
  assignedByUserId String         @map("assigned_by_user_id")
  hierarchyLevel   Int            @default(0) @map("hierarchy_level")
  hierarchyPath    String         @map("hierarchy_path")
  canReassign      Boolean        @default(true) @map("can_reassign")
  userId           String?        @map("user_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  integration        ApiIntegration      @relation(fields: [integrationId], references: [id])
  transactions       Transaction[]
  commissionSettings CommissionSetting[]
  ledgerEntries      LedgerEntry[]
  apiEntities        ApiEntity[]
  assignedByUser     User?               @relation("ServiceProviderAssignedByUser", fields: [assignedByUserId], references: [id])
  user               User?               @relation(fields: [userId], references: [id])

  @@index([integrationId])
  @@index([assignedByUserId, assignedByType])
  @@index([hierarchyPath])
  @@index([status])
  @@index([hierarchyLevel])
  @@map("service_providers")
}

model ApiIntegration {
  id              String   @id @default(uuid())
  platformName    String   @map("platform_name") @db.VarChar(50)
  serviceName     String   @map("service_name") @db.VarChar(50)
  apiBaseUrl      String   @map("api_base_url") @db.Text
  credentials     Json     @db.Json
  isActive        Boolean  @default(true) @map("is_active")
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  createdByUser    User              @relation(fields: [createdByUserId], references: [id])
  serviceProviders ServiceProvider[]

  @@unique([platformName, serviceName, createdByUserId])
  @@index([createdByUserId])
  @@index([isActive])
  @@index([platformName, serviceName])
  @@map("api_integrations")
}

// ==================== KYC & ADDRESS SYSTEM ====================

model UserKyc {
  id                 String        @id @default(uuid())
  userId             String        @unique @map("user_id")
  firstName          String        @map("first_name") @db.VarChar(100)
  lastName           String        @map("last_name") @db.VarChar(100)
  fatherName         String        @map("father_name") @db.VarChar(100)
  dob                DateTime
  gender             UserGender
  status             UserKycStatus @default(PENDING)
  type               UserKycType   @default(USER_KYC)
  kycRejectionReason String?       @map("kyc_rejection_reason") @db.Text
  addressId          String        @map("address_id")
  panFile            String        @map("pan_file") @db.VarChar(500)
  aadhaarFile        String        @map("aadhaar_file") @db.VarChar(500)
  addressProofFile   String        @map("address_proof_file") @db.VarChar(500)
  photo              String        @db.VarChar(500)
  roleType           RoleType      @default(PROPRIETOR) @map("role_type")
  businessKycId      String?       @map("business_kyc_id")
  verifiedByType     String?       @map("verified_by_type")
  verifiedByUserId   String?       @map("verified_by_user_id")
  verifiedAt         DateTime?     @map("verified_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  deletedAt          DateTime?     @map("deleted_at")

  user           User         @relation(fields: [userId], references: [id])
  address        Address      @relation(fields: [addressId], references: [id])
  piiConsents    PiiConsent[]
  businessKyc    BusinessKyc? @relation(fields: [businessKycId], references: [id])
  verifiedByUser User?        @relation("UserKycVerifiedByUser", fields: [verifiedByUserId], references: [id])

  @@index([userId])
  @@index([businessKycId])
  @@index([status])
  @@index([verifiedByUserId])
  @@index([addressId])
  @@index([roleType])
  @@index([deletedAt])
  @@map("user_kyc")
}

model BusinessKyc {
  id                    String       @id @default(uuid())
  userId                String       @map("user_id")
  businessName          String       @map("business_name") @db.VarChar(200)
  businessType          BusinessType @map("business_type")
  status                KycStatus    @default(PENDING)
  rejectionReason       String?      @map("rejection_reason") @db.Text
  addressId             String       @map("address_id")
  panFile               String       @map("pan_file") @db.VarChar(500)
  gstFile               String       @map("gst_file") @db.VarChar(500)
  brDoc                 String?      @map("br_doc") @db.VarChar(500)
  partnershipDeed       String?      @map("partnership_deed") @db.VarChar(500)
  partnerKycNumbers     Int?         @map("partner_kyc_numbers")
  cin                   String?      @map("cin") @db.VarChar(25)
  moaFile               String?      @map("moa_file") @db.VarChar(500)
  aoaFile               String?      @map("aoa_file") @db.VarChar(500)
  authorizedMemberCount Int          @map("authorized_member_count")
  directorShareholding  String?      @map("director_shareholding_file") @db.VarChar(500)
  verifiedByType        String?      @map("verified_by_type")
  verifiedByUserId      String?      @map("verified_by_user_id")
  verifiedByEmployeeId  String?      @map("verified_by_employee_id")
  verifiedAt            DateTime?    @map("verified_at")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  user               User         @relation(fields: [userId], references: [id])
  address            Address      @relation(fields: [addressId], references: [id])
  userKycs           UserKyc[]
  piiConsents        PiiConsent[]
  verifiedByUser     User?        @relation("BusinessKycVerifiedByUser", fields: [verifiedByUserId], references: [id])
  verifiedByEmployee Employee?    @relation("BusinessKycVerifiedByEmployee", fields: [verifiedByEmployeeId], references: [id])

  @@unique([userId])
  @@index([userId, status])
  @@index([verifiedByUserId, verifiedByEmployeeId])
  @@index([businessType])
  @@index([addressId])
  @@map("business_kycs")
}

model State {
  id        String    @id @default(uuid())
  stateName String    @map("state_name") @db.VarChar(100)
  stateCode String    @unique @map("state_code") @db.VarChar(10)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  addresses Address[]
  cities    City[]

  @@index([stateName])
  @@index([stateCode])
  @@map("states")
}

model City {
  id        String    @id @default(uuid())
  cityName  String    @map("city_name") @db.VarChar(100)
  cityCode  String    @unique @map("city_code") @db.VarChar(10)
  stateId   String?   @map("state_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  addresses Address[]
  state     State?    @relation(fields: [stateId], references: [id])

  @@index([cityName])
  @@index([stateId])
  @@index([cityCode])
  @@map("cities")
}

model Address {
  id           String        @id @default(uuid())
  address      String        @db.Text
  pinCode      String        @map("pin_code") @db.VarChar(10)
  stateId      String        @map("state_id")
  cityId       String        @map("city_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  city         City          @relation(fields: [cityId], references: [id])
  state        State         @relation(fields: [stateId], references: [id])
  userKycs     UserKyc[]
  businessKycs BusinessKyc[]

  @@index([cityId])
  @@index([stateId])
  @@index([pinCode])
  @@map("addresses")
}

// ==================== API & WEBHOOK SYSTEM ====================

model ApiEntity {
  id               String       @id @default(uuid())
  entityType       String       @map("entity_type") @db.VarChar(50)
  entityId         String       @unique @map("entity_id") @db.VarChar(100)
  reference        String?      @unique @db.VarChar(100)
  userId           String       @map("user_id")
  serviceId        String?      @map("service_id")
  status           EntityStatus @default(PENDING)
  isActive         Boolean      @default(true) @map("is_active")
  provider         ProviderType
  providerData     Json?        @map("provider_data") @db.Json
  metadata         Json?        @db.Json
  verificationData Json?        @map("verification_data") @db.Json
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  verifiedAt       DateTime?    @map("verified_at")

  user         User             @relation(fields: [userId], references: [id])
  service      ServiceProvider? @relation(fields: [serviceId], references: [id])
  apiWebhooks  ApiWebhook[]
  transactions Transaction[]

  @@index([userId, serviceId])
  @@index([entityType, entityId])
  @@index([status, createdAt])
  @@index([reference])
  @@index([isActive, status])
  @@map("api_entities")
}

model ApiWebhook {
  id            String          @id @default(uuid())
  transactionId String?         @map("transaction_id")
  apiEntityId   String          @map("api_entity_id")
  provider      WebhookProvider
  eventType     String          @map("event_type") @db.VarChar(100)
  payload       Json            @db.Json
  signature     String?         @db.VarChar(500)
  headers       Json?           @db.Json
  status        WebhookStatus   @default(PENDING)
  attempts      Int             @default(0)
  lastAttemptAt DateTime?       @map("last_attempt_at")
  response      Json?           @db.Json
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  apiEntity   ApiEntity    @relation(fields: [apiEntityId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([apiEntityId])
  @@index([provider, eventType])
  @@index([status, createdAt])
  @@index([lastAttemptAt])
  @@index([status, attempts])
  @@map("api_webhooks")
}

// ==================== SECURITY & SETTINGS ====================

model IpWhitelist {
  id         String   @id @default(uuid())
  domainName String   @unique @map("domain_name") @db.VarChar(255)
  serverIp   String   @map("server_ip") @db.Inet // Using INET type for IP addresses
  userId     String?  @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([domainName])
  @@index([userId])
  @@index([serverIp])
  @@map("ip_whitelists")
}

model SystemSetting {
  id             String  @id @default(uuid())
  companyName    String?
  companyLogo    String?
  favIcon        String?
  phoneNumber    String?
  whatsappNumber String?
  companyEmail   String?
  facebookUrl    String?
  instagramUrl   String?
  twitterUrl     String?
  linkedinUrl    String?
  websiteUrl     String?
  settings       Json?

  userId    String
  updatedBy String
  user      User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@map("system_settings")
}

model PiiConsent {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  userKycId     String?  @map("user_kyc_id")
  businessKycId String?  @map("business_kyc_id")
  piiType       String   @db.VarChar(50)
  piiHash       String   @db.VarChar(64)
  providedAt    DateTime @default(now()) @map("provided_at")
  expiresAt     DateTime @map("expires_at")
  scope         String   @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id])
  userKyc     UserKyc?     @relation(fields: [userKycId], references: [id])
  businessKyc BusinessKyc? @relation(fields: [businessKycId], references: [id])

  @@unique([userId, piiType, scope])
  @@index([userKycId])
  @@index([businessKycId])
  @@index([expiresAt])
  @@index([piiHash])
  @@map("pii_consents")
}

model Refund {
  id            String       @id @default(uuid())
  transactionId String       @map("transaction_id")
  initiatedBy   String       @map("initiated_by") @db.VarChar(100)
  amount        Decimal      @db.Decimal(20, 2)
  status        RefundStatus @default(PENDING)
  reason        String?      @db.VarChar(500)
  metadata      Json?        @db.Json
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([status, createdAt])
  @@index([initiatedBy])
  @@map("refunds")
}

model IdempotencyKey {
  key       String   @id @db.VarChar(255)
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  meta      Json?    @db.Json

  @@index([key])
  @@index([userId])
  @@index([expiresAt])
  @@index([used])
  @@map("idempotency_keys")
}

// ==================== AUDIT SYSTEM ====================

model AuditLog {
  id             String      @id @default(uuid())
  performerType  String      @map("performer_type")
  performerId    String      @map("performer_id")
  targetUserType String      @map("target_user_type")
  targetUserId   String      @map("target_user_id")
  action         String      @db.VarChar(100)
  description    String      @db.Text
  resourceType   String      @map("resource_type") @db.VarChar(50)
  resourceId     String      @map("resource_id")
  oldData        Json?       @map("old_data") @db.Json
  newData        Json?       @map("new_data") @db.Json
  status         AuditStatus
  ipAddress      String?     @map("ip_address") @db.Inet // Using INET type
  userAgent      String?     @map("user_agent") @db.Text
  metadata       Json?       @db.Json
  createdAt      DateTime    @default(now()) @map("created_at")

  @@index([performerType, performerId])
  @@index([targetUserType, targetUserId])
  @@index([resourceType, resourceId])
  @@index([status, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== ENUMS (Unchanged) ====================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CreatorType {
  USER
  EMPLOYEE
}

enum VerifiedByType {
  USER
  EMPLOYEE
}

enum BankAccountType {
  PERSONAL
  BUSINESS
}

enum CommissionType {
  FLAT
  PERCENTAGE
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REVERSED
  REFUNDED
  CANCELLED
}

enum CommissionStatus {
  PENDING
  PROCESSED
  FAILED
  CANCELLED
}

enum CommissionScope {
  ROLE
  USER
}

enum LedgerEntryType {
  DEBIT
  CREDIT
}

enum ReferenceType {
  TRANSACTION
  COMMISSION
  REFUND
  ADJUSTMENT
  BONUS
  CHARGE
  FEE
  TAX
  PAYOUT
  COLLECTION
}

enum Currency {
  INR
}

enum WalletType {
  PRIMARY
  COMMISSION
  ESCROW
  TAX
  BONUS
  HOLDING
}

enum PaymentType {
  COLLECTION
  PAYOUT
  REFUND
  REVERSAL
  COMMISSION
  FEE
  TAX
  ADJUSTMENT
  CHARGE
  FUND_REQ_BANK
  FUND_REQ_RAZORPAY
}

enum UserGender {
  MALE
  FEMALE
  OTHER
}

enum KycStatus {
  UNDER_REVIEW
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum UserKycStatus {
  UNDER_REVIEW
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum UserKycType {
  AEPS
  USER_KYC
}

enum RoleType {
  PROPRIETOR
  PARTNER
  DIRECTOR
}

enum BusinessType {
  PROPRIETORSHIP
  PARTNERSHIP
  PRIVATE_LIMITED
}

enum EntityStatus {
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
  INACTIVE
}

enum ProviderType {
  BULKPE
  PAYTM
  RAZORPAY
  CCAVENUE
  BILLDESK
  AIRTEL
  JIO
  OTHER
}

enum WebhookProvider {
  BULKPE
  PAYTM
  RAZORPAY
  CCAVENUE
  BILLDESK
  AIRTEL
  JIO
  OTHER
}

enum WebhookStatus {
  PENDING
  PROCESSED
  FAILED
  RETRY
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AssignedByType {
  USER
}

enum BankDetailStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
  CANCELLED
  SUCCESS
}

enum AuditStatus {
  SUCCESS
  FAILED
  PENDING
}

enum PermissionTargetType {
  ROLE
  USER
  DEPARTMENT
  EMPLOYEE
}
