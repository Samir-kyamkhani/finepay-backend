generator client {
  provider      = "prisma-client"
  output        = "../generated/prisma"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
}

// ==================== BUSINESS / TENANT SYSTEM ====================

model Business {
  id           String       @id @default(uuid())
  businessId   String       @unique @map("business_id") @db.VarChar(8)
  name         String
  businessType BusinessType @map("business_type")
  status       String       @default("ACTIVE")
  createdBy    String // ROOT user id
  createdAt    DateTime     @default(now())

  users              User[]
  roles              Role[]
  departments        Department[]
  ipWhitelists       IpWhitelist[]
  wallets            Wallet[]
  transactions       Transaction[]
  ledgerEntries      LedgerEntry[]
  commissionSettings CommissionSetting[]
  auditLogs          AuditLog[]
  employees          Employee[]
  commissionEarnings CommissionEarning[]
  businessKyc        BusinessKyc?

  @@map("businesses")
}

// ==================== CORE USER SYSTEM ====================

model User {
  id             String     @id @default(uuid())
  customerId     String?     @unique @map("customer_id") @db.VarChar(8)
  authUserId     String     @unique @map("auth_user_id")
  firstName      String     @map("first_name")
  lastName       String     @map("last_name")
  profileImage   String?    @map("profile_image") @db.Text
  email          String     @unique
  phoneNumber    String     @unique @map("phone_number")
  password       String
  transactionPin String?    @map("transaction_pin")
  hierarchyLevel Int        @default(0) @map("hierarchy_level")
  hierarchyPath  String     @map("hierarchy_path")
  status         UserStatus @default(INACTIVE)
  isKycVerified  Boolean    @default(false) @map("is_kyc_verified")
  roleId         String?    @map("role_id")

  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt     DateTime? @map("last_login_at")
  lastLoginIp     String?   @map("last_login_ip") @db.Inet
  lastLoginOrigin String?   @map("last_login_origin")
  actionReason    String?   @map("action_reason") @db.Text
  actionedAt      DateTime  @map("actioned_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  parentId      String?     @map("parent_id")
  businessKycId String?     @map("business_kyc_id")
  userType      CreatorType @default(USER) @map("user_type")

  // Business boundary - NULL for ROOT users only
  businessId String?   @map("business_id")
  business   Business? @relation(fields: [businessId], references: [id])

  role     Role?  @relation(fields: [roleId], references: [id])
  parent   User?  @relation("UserHierarchy", fields: [parentId], references: [id])
  children User[] @relation("UserHierarchy")

  wallets      Wallet[]
  bankDetails  BankDetail[]
  userKyc      UserKyc?
  businessKyc  BusinessKyc?  @relation(fields: [businessKycId], references: [id])
  transactions Transaction[]

  commissionEarnings CommissionEarning[] @relation("CommissionEarningToUser")
  commissionsGiven   CommissionEarning[] @relation("CommissionEarningFromUser")

  piiConsents  PiiConsent[]
  apiEntities  ApiEntity[]
  ipWhitelists IpWhitelist[]
  employees    Employee[]

  commissionSettings        CommissionSetting[] @relation("CommissionSettingForUser")
  commissionSettingsCreated CommissionSetting[] @relation("CommissionSettingCreatedByUser")
  rolesCreated              Role[]              @relation("RoleCreatedByUser")
  departmentsCreated        Department[]        @relation("DepartmentCreatedByUser")
  serviceProviders          ServiceProvider[]
  serviceProvidersAssigned  ServiceProvider[]   @relation("ServiceProviderAssignedByUser")
  systemSettings            SystemSetting[]

  UserKycSubmittedByUser UserKyc[]        @relation("UserKycSubmittedByUser")
  UserKycVerifiedByUser  UserKyc[]        @relation("UserKycVerifiedByUser")
  apiIntegrations        ApiIntegration[]
  userPermissions        UserPermission[]
  businessKycVerified    BusinessKyc[]    @relation("BusinessKycVerifiedByUser")
  businessKycsSubmitted  BusinessKyc[]    @relation("BusinessKycSubmittedByUser")

  name          String
  emailVerified Boolean     @default(false)
  image         String?
  sessions      Session[]
  accounts      Account[]
  smtpConfig    SmtpConfig?

  @@index([parentId])
  @@index([hierarchyLevel])
  @@index([hierarchyPath])
  @@index([roleId])
  @@index([customerId])
  @@index([businessKycId])
  @@index([email])
  @@index([phoneNumber])
  @@index([deletedAt])
  @@index([businessId])
  @@map("users")
}

model Employee {
  id              String         @id @default(uuid())
  authUserId      String         @unique @map("auth_user_id")
  username        String         @unique
  firstName       String         @map("first_name")
  lastName        String         @map("last_name")
  profileImage    String?        @map("profile_image") @db.Text
  email           String         @unique
  password        String
  phoneNumber     String         @unique @map("phone_number")
  departmentId    String         @map("department_id")
  status          EmployeeStatus @default(INACTIVE)
  lastLoginAt     DateTime?      @map("last_login_at")
  lastLoginIp     String?        @map("last_login_ip") @db.Inet
  lastLoginOrigin String?        @map("last_login_origin")
  actionReason    String?        @map("action_reason") @db.Text
  actionedAt      DateTime       @map("actioned_at")
  createdById     String         @map("created_by_user_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Business boundary - REQUIRED for all employees
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  department                Department           @relation(fields: [departmentId], references: [id])
  createdBy                 User                 @relation(fields: [createdById], references: [id])
  commissionSettings        CommissionSetting[]  @relation("CommissionSettingCreatedByEmployee")
  businessKycVerified       BusinessKyc[]        @relation("BusinessKycVerifiedByEmployee")
  UserKycVerifiedByEmployee UserKyc[]            @relation("UserKycVerifiedByEmployee")
  employeePermissions       EmployeePermission[]

  @@index([departmentId])
  @@index([createdById])
  @@index([email])
  @@index([phoneNumber])
  @@index([businessId])
  @@map("employees")
}

// ==================== SIMPLIFIED PERMISSION SYSTEM ====================

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(100)
  resource    String   @db.VarChar(200)
  action      String   @db.VarChar(200)
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions       RolePermission[]
  userPermissions       UserPermission[]
  employeePermissions   EmployeePermission[]
  departmentPermissions DepartmentPermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserPermission {
  userId       String
  permissionId String

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  effect     PermissionEffect @default(ALLOW)
  assignedAt DateTime         @default(now())

  @@id([userId, permissionId])
  @@index([permissionId])
  @@map("user_permissions")
}

model EmployeePermission {
  employeeId   String
  permissionId String

  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  effect     PermissionEffect @default(ALLOW)
  assignedAt DateTime         @default(now())

  @@id([employeeId, permissionId])
  @@index([permissionId])
  @@map("employee_permissions")
}

model DepartmentPermission {
  departmentId String
  permissionId String

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([departmentId, permissionId])
  @@index([permissionId])
  @@map("department_permissions")
}

// ==================== WALLET & TRANSACTION SYSTEM ====================

model Wallet {
  id                  String     @id @default(uuid())
  userId              String     @map("user_id")
  balance             Decimal    @default(0) @db.Decimal(20, 2)
  currency            Currency   @default(INR)
  walletType          WalletType @default(PRIMARY) @map("wallet_type")
  holdBalance         Decimal    @default(0) @map("hold_balance") @db.Decimal(20, 2)
  availableBalance    Decimal    @default(0) @map("available_balance") @db.Decimal(20, 2)
  dailyLimit          Decimal?   @map("daily_limit") @db.Decimal(20, 2)
  monthlyLimit        Decimal?   @map("monthly_limit") @db.Decimal(20, 2)
  perTransactionLimit Decimal?   @map("per_transaction_limit") @db.Decimal(20, 2)
  isActive            Boolean    @default(true) @map("is_active")
  version             Int        @default(1)
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  deletedAt           DateTime?  @map("deleted_at")

  // Business boundary - REQUIRED for all financial data
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  user          User          @relation(fields: [userId], references: [id])
  ledgerEntries LedgerEntry[]
  transactions  Transaction[]

  @@unique([userId, walletType])
  @@index([userId])
  @@index([walletType])
  @@index([isActive])
  @@index([createdAt])
  @@index([balance])
  @@index([deletedAt])
  @@index([businessId])
  @@map("wallets")
}

model Transaction {
  id                String            @id @default(uuid())
  referenceId       String?           @unique @map("reference_id") @db.VarChar(50)
  externalRefId     String?           @map("external_ref_id") @db.VarChar(100)
  idempotencyKey    String?           @unique @map("idempotency_key") @db.VarChar(255)
  amount            Decimal           @db.Decimal(20, 2)
  currency          Currency          @default(INR)
  netAmount         Decimal           @map("net_amount") @db.Decimal(20, 2)
  status            TransactionStatus @default(PENDING)
  serviceId         String?           @map("service_id")
  paymentType       PaymentType       @map("payment_type")
  userId            String            @map("user_id")
  walletId          String            @map("wallet_id")
  apiEntityId       String?           @map("api_entity_id")
  totalCommission   Decimal           @default(0) @map("total_commission") @db.Decimal(20, 2)
  providerCharge    Decimal?          @map("provider_charge") @db.Decimal(20, 2)
  taxAmount         Decimal?          @map("tax_amount") @db.Decimal(20, 2)
  feeAmount         Decimal?          @map("fee_amount") @db.Decimal(20, 2)
  cashbackAmount    Decimal?          @map("cashback_amount") @db.Decimal(20, 2)
  providerReference String?           @map("provider_reference") @db.VarChar(100)
  providerResponse  Json?             @map("provider_response") @db.Json
  requestPayload    Json?             @map("request_payload") @db.Json
  responsePayload   Json?             @map("response_payload") @db.Json
  initiatedAt       DateTime          @default(now()) @map("initiated_at")
  processedAt       DateTime?         @map("processed_at")
  completedAt       DateTime?         @map("completed_at")

  // Business boundary - REQUIRED for all financial data
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  user               User                @relation(fields: [userId], references: [id])
  wallet             Wallet              @relation(fields: [walletId], references: [id])
  apiEntity          ApiEntity?          @relation(fields: [apiEntityId], references: [id])
  service            ServiceProvider?    @relation(fields: [serviceId], references: [id])
  apiWebhooks        ApiWebhook[]
  commissionEarnings CommissionEarning[]
  ledgerEntries      LedgerEntry[]
  refunds            Refund[]

  @@index([userId])
  @@index([walletId])
  @@index([serviceId])
  @@index([apiEntityId])
  @@index([initiatedAt])
  @@index([status, initiatedAt])
  @@index([paymentType])
  @@index([processedAt])
  @@index([completedAt])
  @@index([externalRefId])
  @@index([providerReference])
  @@index([userId, status, initiatedAt])
  @@index([walletId, status, initiatedAt])
  @@index([businessId])
  @@map("transactions")
}

model CommissionEarning {
  id               String           @id @default(uuid())
  transactionId    String           @map("transaction_id")
  userId           String           @map("user_id")
  fromUserId       String?          @map("from_user_id")
  amount           Decimal          @db.Decimal(20, 2)
  commissionAmount Decimal          @map("commission_amount") @db.Decimal(20, 2)
  commissionType   CommissionType   @map("commission_type")
  tdsAmount        Decimal?         @map("tds_amount") @db.Decimal(20, 2)
  gstAmount        Decimal?         @map("gst_amount") @db.Decimal(20, 2)
  netAmount        Decimal          @map("net_amount") @db.Decimal(20, 2)
  status           CommissionStatus @default(PENDING)
  metadata         Json?            @db.Json
  processedAt      DateTime?        @map("processed_at")
  cancelledAt      DateTime?        @map("cancelled_at")
  failureReason    String?          @map("failure_reason") @db.Text
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Business boundary - REQUIRED for all financial data
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  transaction Transaction @relation(fields: [transactionId], references: [id])
  user        User        @relation("CommissionEarningToUser", fields: [userId], references: [id])
  fromUser    User?       @relation("CommissionEarningFromUser", fields: [fromUserId], references: [id])

  @@index([transactionId, userId])
  @@index([userId, createdAt])
  @@index([fromUserId, createdAt])
  @@index([status, createdAt])
  @@index([processedAt])
  @@index([cancelledAt])
  @@index([userId, status, createdAt])
  @@index([businessId])
  @@map("commission_earnings")
}

model BankDetail {
  id                  String           @id @default(uuid())
  accountHolder       String           @map("account_holder") @db.VarChar(100)
  accountNumber       String           @unique @map("account_number") @db.VarChar(18)
  phoneNumber         String           @map("phone_number") @db.VarChar(15)
  accountType         BankAccountType  @map("account_type")
  ifscCode            String           @map("ifsc_code") @db.VarChar(11)
  bankName            String           @map("bank_name") @db.VarChar(100)
  bankRejectionReason String?          @map("bank_rejection_reason") @db.Text
  bankProofFile       String           @map("bank_proof_file") @db.VarChar(500)
  status              BankDetailStatus @default(PENDING)
  isPrimary           Boolean          @default(false) @map("is_primary")
  userId              String           @map("user_id")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, isPrimary])
  @@index([userId])
  @@index([status])
  @@index([isPrimary])
  @@index([createdAt])
  @@index([ifscCode])
  @@map("bank_details")
}

model LedgerEntry {
  id             String          @id @default(uuid())
  transactionId  String?         @map("transaction_id")
  walletId       String          @map("wallet_id")
  entryType      LedgerEntryType @map("entry_type")
  referenceType  ReferenceType   @map("reference_type")
  serviceId      String?         @map("service_id")
  amount         Decimal         @db.Decimal(20, 2)
  runningBalance Decimal         @map("running_balance") @db.Decimal(20, 2)
  narration      String          @db.VarChar(500)
  metadata       Json?           @db.Json
  idempotencyKey String          @unique @map("idempotency_key") @db.VarChar(255)
  createdAt      DateTime        @default(now()) @map("created_at")

  // Business boundary - REQUIRED for all financial data
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  service     ServiceProvider? @relation(fields: [serviceId], references: [id])
  transaction Transaction?     @relation(fields: [transactionId], references: [id])
  wallet      Wallet           @relation(fields: [walletId], references: [id])

  @@index([transactionId])
  @@index([walletId, createdAt])
  @@index([serviceId, referenceType])
  @@index([entryType, createdAt])
  @@index([referenceType, createdAt])
  @@index([createdAt])
  @@index([walletId, entryType, createdAt])
  @@index([walletId, runningBalance])
  @@index([businessId])
  @@map("ledger_entries")
}

// ==================== COMMISSION & SETTINGS ====================

model CommissionSetting {
  id String @id @default(uuid())

  scope        CommissionScope @map("scope")
  roleId       String?         @map("role_id")
  targetUserId String?         @map("target_user_id")
  serviceId    String?         @map("service_id")

  commissionType  CommissionType? @map("commission_type")
  commissionValue Decimal?        @map("commission_value") @db.Decimal(12, 4)

  surchargeType  CommissionType? @map("surcharge_type")
  surchargeValue Decimal?        @map("surcharge_value") @db.Decimal(12, 4)

  minAmount Decimal? @map("min_amount") @db.Decimal(20, 2)
  maxAmount Decimal? @map("max_amount") @db.Decimal(20, 2)

  applyTDS   Boolean  @default(false) @map("apply_tds")
  tdsPercent Decimal? @map("tds_percent") @db.Decimal(5, 2)
  applyGST   Boolean  @default(false) @map("apply_gst")
  gstPercent Decimal? @map("gst_percent") @db.Decimal(5, 2)

  isActive      Boolean   @default(true) @map("is_active")
  effectiveFrom DateTime  @default(now()) @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  createdByType       CreatorType @map("created_by_type")
  createdByUserId     String?     @map("created_by_user_id")
  createdByEmployeeId String?     @map("created_by_employee_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Business boundary - REQUIRED for business settings
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  role              Role?            @relation(fields: [roleId], references: [id])
  targetUser        User?            @relation("CommissionSettingForUser", fields: [targetUserId], references: [id])
  service           ServiceProvider? @relation(fields: [serviceId], references: [id])
  createdByUser     User?            @relation("CommissionSettingCreatedByUser", fields: [createdByUserId], references: [id])
  createdByEmployee Employee?        @relation("CommissionSettingCreatedByEmployee", fields: [createdByEmployeeId], references: [id])

  @@index([scope, roleId, targetUserId])
  @@index([serviceId, isActive])
  @@index([createdByType, createdByUserId, createdByEmployeeId])
  @@index([effectiveFrom, effectiveTo])
  @@index([scope, roleId, targetUserId, serviceId])
  @@index([businessId])
  @@map("commission_settings")
}

// ==================== ROLE & DEPARTMENT ====================

model Role {
  id          String  @id @default(uuid())
  name        String  @unique @db.VarChar(50)
  description String? @db.Text

  // Hierarchy fields
  parentId       String? @map("parent_id")
  hierarchyLevel Int     @default(0) @map("hierarchy_level")
  hierarchyPath  String  @map("hierarchy_path") @db.Text

  // Status and metadata
  permissions   Json?   @db.Json
  isIpWhitelist Boolean @default(false) @map("is_ipwhitelist")

  createdByType   CreatorType @map("created_by_type")
  createdByUserId String?     @map("created_by_user_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Business boundary - NULL for system roles only
  businessId String?   @map("business_id")
  business   Business? @relation(fields: [businessId], references: [id])

  // Relations
  parent   Role?  @relation("RoleHierarchy", fields: [parentId], references: [id])
  children Role[] @relation("RoleHierarchy")

  users              User[]
  commissionSettings CommissionSetting[]
  createdByUser      User?               @relation("RoleCreatedByUser", fields: [createdByUserId], references: [id])
  rolePermissions    RolePermission[]

  @@index([parentId])
  @@index([hierarchyLevel])
  @@index([hierarchyPath])
  @@index([createdByUserId, createdByType])
  @@index([name])
  @@index([hierarchyLevel, hierarchyPath])
  @@index([businessId])
  @@map("roles")
}

model Department {
  id              String      @id @default(uuid())
  name            String      @unique @db.VarChar(50)
  description     String?     @db.Text
  createdByType   CreatorType @map("created_by_type")
  createdByUserId String      @map("created_by_user_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Business boundary - REQUIRED for all departments
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  employees             Employee[]
  createdByUser         User?                  @relation("DepartmentCreatedByUser", fields: [createdByUserId], references: [id])
  departmentPermissions DepartmentPermission[]

  @@index([createdByUserId, createdByType])
  @@index([name])
  @@index([businessId])
  @@map("departments")
}

// ==================== SERVICE & INTEGRATION SYSTEM ====================

model ServiceProvider {
  id               String         @id @default(uuid())
  integrationId    String         @map("integration_id")
  serviceName      String         @map("service_name") @db.VarChar(100)
  status           ServiceStatus  @default(ACTIVE)
  assignedByType   AssignedByType @map("assigned_by_type")
  assignedByUserId String         @map("assigned_by_user_id")
  hierarchyLevel   Int            @default(0) @map("hierarchy_level")
  hierarchyPath    String         @map("hierarchy_path")
  canReassign      Boolean        @default(true) @map("can_reassign")
  userId           String?        @map("user_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  integration        ApiIntegration      @relation(fields: [integrationId], references: [id])
  transactions       Transaction[]
  commissionSettings CommissionSetting[]
  ledgerEntries      LedgerEntry[]
  apiEntities        ApiEntity[]
  assignedByUser     User?               @relation("ServiceProviderAssignedByUser", fields: [assignedByUserId], references: [id])
  user               User?               @relation(fields: [userId], references: [id])

  @@index([integrationId])
  @@index([assignedByUserId, assignedByType])
  @@index([hierarchyPath])
  @@index([status])
  @@index([hierarchyLevel])
  @@map("service_providers")
}

model ApiIntegration {
  id              String   @id @default(uuid())
  platformName    String   @map("platform_name") @db.VarChar(50)
  serviceName     String   @map("service_name") @db.VarChar(50)
  apiBaseUrl      String   @map("api_base_url") @db.Text
  credentials     Json     @db.Json
  isActive        Boolean  @default(true) @map("is_active")
  createdByUserId String   @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  createdByUser    User              @relation(fields: [createdByUserId], references: [id])
  serviceProviders ServiceProvider[]

  @@unique([platformName, serviceName, createdByUserId])
  @@index([createdByUserId])
  @@index([isActive])
  @@index([platformName, serviceName])
  @@map("api_integrations")
}

// ==================== KYC & ADDRESS SYSTEM ====================

model UserKyc {
  id         String        @id @default(uuid())
  userId     String        @unique @map("user_id")
  firstName  String        @map("first_name") @db.VarChar(100)
  lastName   String        @map("last_name") @db.VarChar(100)
  fatherName String        @map("father_name") @db.VarChar(100)
  dob        DateTime
  gender     UserGender
  status     UserKycStatus @default(PENDING)
  type       UserKycType   @default(USER_KYC)

  actionReason String?   @map("action_reason") @db.Text
  actionedAt   DateTime? @map("actioned_at")

  addressId        String    @map("address_id")
  panFile          String    @map("pan_file") @db.VarChar(500)
  aadhaarFile      String    @map("aadhaar_file") @db.VarChar(500)
  addressProofFile String    @map("address_proof_file") @db.VarChar(500)
  photo            String    @db.VarChar(500)
  roleType         RoleType  @default(PROPRIETOR) @map("role_type")
  businessKycId    String?   @map("business_kyc_id")
  verifiedByType   String?   @map("verified_by_type")
  verifiedAt       DateTime? @map("verified_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  user        User         @relation(fields: [userId], references: [id])
  address     Address      @relation(fields: [addressId], references: [id])
  piiConsents PiiConsent[]
  businessKyc BusinessKyc? @relation(fields: [businessKycId], references: [id])

  //  This is a MANY-TO-ONE relationship, not one-to-one
  submittedByUserId String
  submittedByUser   User   @relation("UserKycSubmittedByUser", fields: [submittedByUserId], references: [id])

  //  These are optional one-to-many relationships
  verifiedByUserId String?
  verifiedByUser   User?   @relation("UserKycVerifiedByUser", fields: [verifiedByUserId], references: [id])

  verifiedByEmployeeId String?
  verifiedByEmployee   Employee? @relation("UserKycVerifiedByEmployee", fields: [verifiedByEmployeeId], references: [id])

  @@index([userId])
  @@index([businessKycId])
  @@index([status])
  @@index([verifiedByUserId])
  @@index([addressId])
  @@index([roleType])
  @@index([deletedAt])
  @@map("user_kyc")
}

model BusinessKyc {
  id                String    @id @default(uuid())
  status            KycStatus @default(PENDING)
  panFile           String
  gstFile           String?
  cin               String?
  moaFile           String?
  aoaFile           String?
  brDoc             String?   @map("br_doc") @db.VarChar(500)
  partnershipDeed   String?   @map("partnership_deed") @db.VarChar(500)
  partnerKycNumbers Int?      @map("partner_kyc_numbers")

  actionReason   String?      @map("action_reason") @db.Text
  actionedAt     DateTime?    @map("actioned_at")
  verifiedByType CreatorType?

  directorsCount       Int     @map("directors_count")
  directorShareholding String? @map("director_shareholding_file") @db.VarChar(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessId String   @unique
  business   Business @relation(fields: [businessId], references: [id])

  addressId String
  address   Address @relation(fields: [addressId], references: [id])

  //  This is a MANY-TO-ONE relationship, not one-to-one
  submittedByUserId String
  submittedByUser   User   @relation("BusinessKycSubmittedByUser", fields: [submittedByUserId], references: [id])

  //  These are optional one-to-many relationships
  verifiedByUserId String?
  verifiedByUser   User?   @relation("BusinessKycVerifiedByUser", fields: [verifiedByUserId], references: [id])

  verifiedByEmployeeId String?
  verifiedByEmployee   Employee? @relation("BusinessKycVerifiedByEmployee", fields: [verifiedByEmployeeId], references: [id])

  userKycs    UserKyc[]
  piiConsents PiiConsent[]
  users       User[]

  @@index([status])
  @@index([businessId])
  @@index([submittedByUserId])
  @@index([verifiedByUserId])
  @@index([verifiedByEmployeeId])
  @@map("business_kycs")
}

model State {
  id        String    @id @default(uuid())
  stateName String    @map("state_name") @db.VarChar(100)
  stateCode String    @unique @map("state_code") @db.VarChar(10)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  addresses Address[]
  cities    City[]

  @@index([stateName])
  @@index([stateCode])
  @@map("states")
}

model City {
  id        String    @id @default(uuid())
  cityName  String    @map("city_name") @db.VarChar(100)
  cityCode  String    @unique @map("city_code") @db.VarChar(10)
  stateId   String?   @map("state_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  addresses Address[]
  state     State?    @relation(fields: [stateId], references: [id])

  @@index([cityName])
  @@index([stateId])
  @@index([cityCode])
  @@map("cities")
}

model Address {
  id           String        @id @default(uuid())
  address      String        @db.Text
  pinCode      String        @map("pin_code") @db.VarChar(10)
  stateId      String        @map("state_id")
  cityId       String        @map("city_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  city         City          @relation(fields: [cityId], references: [id])
  state        State         @relation(fields: [stateId], references: [id])
  userKycs     UserKyc[]
  businessKycs BusinessKyc[]

  @@index([cityId])
  @@index([stateId])
  @@index([pinCode])
  @@map("addresses")
}

model SmtpConfig {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  provider SmtpProvider
  host     String
  port     Int
  secure   Boolean

  username    String
  passwordEnc String @map("password_enc")

  fromEmail String  @map("from_email")
  fromName  String? @map("from_name")

  supportEmail String @map("support_email")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([provider])
  @@index([isActive])
  @@map("smtp_configs")
}

// ==================== API & WEBHOOK SYSTEM ====================

model ApiEntity {
  id               String       @id @default(uuid())
  entityType       String       @map("entity_type") @db.VarChar(50)
  entityId         String       @unique @map("entity_id") @db.VarChar(100)
  reference        String?      @unique @db.VarChar(100)
  userId           String       @map("user_id")
  serviceId        String?      @map("service_id")
  status           EntityStatus @default(PENDING)
  isActive         Boolean      @default(true) @map("is_active")
  provider         ProviderType
  providerData     Json?        @map("provider_data") @db.Json
  metadata         Json?        @db.Json
  verificationData Json?        @map("verification_data") @db.Json
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  verifiedAt       DateTime?    @map("verified_at")

  user         User             @relation(fields: [userId], references: [id])
  service      ServiceProvider? @relation(fields: [serviceId], references: [id])
  apiWebhooks  ApiWebhook[]
  transactions Transaction[]

  @@index([userId, serviceId])
  @@index([entityType, entityId])
  @@index([status, createdAt])
  @@index([reference])
  @@index([isActive, status])
  @@map("api_entities")
}

model ApiWebhook {
  id            String          @id @default(uuid())
  transactionId String?         @map("transaction_id")
  apiEntityId   String          @map("api_entity_id")
  provider      WebhookProvider
  eventType     String          @map("event_type") @db.VarChar(100)
  payload       Json            @db.Json
  signature     String?         @db.VarChar(500)
  headers       Json?           @db.Json
  status        WebhookStatus   @default(PENDING)
  attempts      Int             @default(0)
  lastAttemptAt DateTime?       @map("last_attempt_at")
  response      Json?           @db.Json
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  apiEntity   ApiEntity    @relation(fields: [apiEntityId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([apiEntityId])
  @@index([provider, eventType])
  @@index([status, createdAt])
  @@index([lastAttemptAt])
  @@index([status, attempts])
  @@map("api_webhooks")
}

// ==================== SECURITY & SETTINGS ====================

model IpWhitelist {
  id         String @id @default(uuid())
  domainName String @unique @map("domain_name") @db.VarChar(255)
  serverIp   String @map("server_ip") @db.Inet

  // Business boundary - REQUIRED for business security
  businessId String   @map("business_id")
  business   Business @relation(fields: [businessId], references: [id])

  // Optional for backward compatibility
  userId String? @map("user_id")

  ipAddress String? @map("ip_address") @db.Inet
  cidrRange String? @map("cidr_range") @db.VarChar(18)
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([domainName])
  @@index([userId])
  @@index([serverIp])
  @@index([businessId])
  @@index([isActive])
  @@map("ip_whitelists")
}

model SystemSetting {
  id String @id @default(uuid())

  companyName String? @map("company_name")
  companyLogo String? @map("company_logo")
  favIcon     String? @map("fav_icon")

  phoneNumber    String? @map("phone_number")
  whatsappNumber String? @map("whatsapp_number")
  companyEmail   String? @map("company_email")

  facebookUrl  String? @map("facebook_url")
  instagramUrl String? @map("instagram_url")
  twitterUrl   String? @map("twitter_url")
  linkedinUrl  String? @map("linkedin_url")
  websiteUrl   String? @map("website_url")

  settings Json? @map("settings")

  userId    String @unique @map("user_id")
  updatedBy String @map("updated_by")

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model PiiConsent {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  userKycId     String?  @map("user_kyc_id")
  businessKycId String?  @map("business_kyc_id")
  piiType       String   @db.VarChar(50)
  piiHash       String   @db.VarChar(64)
  providedAt    DateTime @default(now()) @map("provided_at")
  expiresAt     DateTime @map("expires_at")
  scope         String   @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id])
  userKyc     UserKyc?     @relation(fields: [userKycId], references: [id])
  businessKyc BusinessKyc? @relation(fields: [businessKycId], references: [id])

  @@unique([userId, piiType, scope])
  @@index([userKycId])
  @@index([businessKycId])
  @@index([expiresAt])
  @@index([piiHash])
  @@map("pii_consents")
}

model Refund {
  id            String       @id @default(uuid())
  transactionId String       @map("transaction_id")
  initiatedBy   String       @map("initiated_by") @db.VarChar(100)
  amount        Decimal      @db.Decimal(20, 2)
  status        RefundStatus @default(PENDING)
  reason        String?      @db.VarChar(500)
  metadata      Json?        @db.Json
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([status, createdAt])
  @@index([initiatedBy])
  @@map("refunds")
}

model IdempotencyKey {
  key       String   @id @db.VarChar(255)
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  meta      Json?    @db.Json

  @@index([key])
  @@index([userId])
  @@index([expiresAt])
  @@index([used])
  @@map("idempotency_keys")
}

// ==================== AUDIT SYSTEM ====================

model AuditLog {
  id             String  @id @default(uuid())
  performerType  String  @map("performer_type")
  performerId    String? @map("performer_id")
  targetUserType String  @map("target_user_type")
  targetUserId   String  @map("target_user_id")
  action         String  @db.VarChar(100)
  description    String  @db.Text
  resourceType   String  @map("resource_type") @db.VarChar(50)
  resourceId     String  @map("resource_id")

  // Business boundary - NULL for system actions
  businessId String?   @map("business_id")
  business   Business? @relation(fields: [businessId], references: [id])

  oldData   Json?       @map("old_data") @db.Json
  newData   Json?       @map("new_data") @db.Json
  status    AuditStatus
  ipAddress String?     @map("ip_address") @db.Inet
  userAgent String?     @map("user_agent") @db.Text
  metadata  Json?       @db.Json
  createdAt DateTime    @default(now()) @map("created_at")

  @@index([performerType, performerId])
  @@index([targetUserType, targetUserId])
  @@index([resourceType, resourceId])
  @@index([status, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@index([businessId])
  @@map("audit_logs")
}

// ==================== ENUMS ====================

enum SmtpProvider {
  GMAIL
  OUTLOOK
  CUSTOM
  SES
  SENDGRID
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CreatorType {
  ROOT
  USER
  EMPLOYEE
}

enum VerifiedByType {
  USER
  EMPLOYEE
}

enum BankAccountType {
  PERSONAL
  BUSINESS
}

enum CommissionType {
  FLAT
  PERCENTAGE
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REVERSED
  REFUNDED
  CANCELLED
}

enum CommissionStatus {
  PENDING
  PROCESSED
  FAILED
  CANCELLED
}

enum CommissionScope {
  ROLE
  USER
}

enum LedgerEntryType {
  DEBIT
  CREDIT
}

enum ReferenceType {
  TRANSACTION
  COMMISSION
  REFUND
  ADJUSTMENT
  BONUS
  CHARGE
  FEE
  TAX
  PAYOUT
  COLLECTION
}

enum Currency {
  INR
}

enum WalletType {
  PRIMARY
  COMMISSION
  ESCROW
  TAX
  BONUS
  HOLDING
}

enum PaymentType {
  COLLECTION
  PAYOUT
  REFUND
  REVERSAL
  COMMISSION
  FEE
  TAX
  ADJUSTMENT
  CHARGE
  FUND_REQ_BANK
  FUND_REQ_RAZORPAY
}

enum UserGender {
  MALE
  FEMALE
  OTHER
}

enum KycStatus {
  UNDER_REVIEW
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum UserKycStatus {
  UNDER_REVIEW
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum UserKycType {
  AEPS
  USER_KYC
}

enum RoleType {
  PROPRIETOR
  PARTNER
  DIRECTOR
}

enum BusinessType {
  PROPRIETORSHIP
  PARTNERSHIP
  PRIVATE_LIMITED
}

enum EntityStatus {
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
  INACTIVE
}

enum ProviderType {
  BULKPE
  PAYTM
  RAZORPAY
  CCAVENUE
  BILLDESK
  AIRTEL
  JIO
  OTHER
}

enum WebhookProvider {
  BULKPE
  PAYTM
  RAZORPAY
  CCAVENUE
  BILLDESK
  AIRTEL
  JIO
  OTHER
}

enum WebhookStatus {
  PENDING
  PROCESSED
  FAILED
  RETRY
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AssignedByType {
  USER
}

enum BankDetailStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
  CANCELLED
  SUCCESS
}

enum AuditStatus {
  SUCCESS
  FAILED
  PENDING
}

enum PermissionEffect {
  ALLOW
  DENY
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
